<!DOCTYPE HTML>
<html>
	<head>
		<title>De bijenkast van binnen: Bijenkast v001/c00002/d001</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="assets/css/main.css" />
	</head>
	<body>

		<!-- Header -->
			<header id="header" class="alt">
				<div class="logo"><a href="index_c00002_d001.html"><span>Home</span></a></div>
				<a href="#menu">Menu</a>
			</header>

		<!-- Nav -->
			<nav id="menu">
				<ul class="links">
					<li><a href="index_c00002_d001.html">Home</a></li>
					<li><a href="locaties.html">Locaties</a></li>
					<li><a href="bijen.html">Bijen</a></li>
					<li><a href="vegetatie.html">Vegetatie</a></li>
					<li><a href="information.html">Informatie</a></li>
				</ul>
			</nav>

		<!-- Banner -->
			<section class="banner half">
				<article>
					<img src="images/c00002_d001_1.jpg" alt="" />
					<div class="inner">
						<header>
							<p>Begin van de lente!</p>
							<h2>Bijenkast v001/c00002/d001</h2>
						</header>
					</div>
				</article>
				<article>
					<img src="images/c00002_d001_2.jpg" alt="" />
					<div class="inner">
						<header>
							<p>Begin van de lente!</p>
							<h2>Bijenkast v001/c00002/d001</h2>
						</header>
					</div>
				</article>
				<article>
					<img src="images/c00002_d001_3.jpg"  alt="" />
					<div class="inner">
						<header>
							<p>Begin van de lente!</p>
							<h2>Bijenkast v001/c00002/d001</h2>
						</header>
					</div>
				</article>
				<article>
					<img src="images/c00002_d001_4.jpg"  alt="" />
					<div class="inner">
						<header>
							<p>Begin van de lente!</p>
							<h2>Bijenkast v001/c00002/d001</h2>
						</header>
					</div>
				</article>
				<article>
					<img src="images/c00002_d001_5.jpg"  alt="" />
					<div class="inner">
						<header>
							<p>Begin van de lente!</p>
							<h2>Bijenkast v001/c00002/d001</h2>
						</header>
					</div>
				</article>
			</section>
 
<!-- Zero -->
			<section id="zero" class="wrapper style3">
				<div class="inner">
					<header class="align-center">
					    <p><strong>Status:</strong> <span id="status">Verbinden...</span></p>
					    <input type="text" id="message" placeholder="Stel een vraag aan het bijenvolk?">
					    <button onclick="publishMessage()" id="theButton">Versturen</button>
						<p id="llmStatus"></p>
						<p id="waitingTime"></p>
					    <h2>Ontvangen berichten:</h2>
					    <div id="messages"></div>
					</header>
				</div>
			</section>
 




<!-- One -->
			<section id="one" class="wrapper style2">
				<div class="inner">
					<header class="align-center">



						<div>
							<div class="box">
								
								<div class="content">
									<header class="align-center">
										<p>Informatie vanuit de bijenkast</p>
									</header>
									<p>Volg de bijen door de metingen regelmatig na te lezen.</p>
									<a href="https://smart-isolator.github.io/index_c00002_d001.html">Bekijk de website</a>
									<footer class="align-center">
										<a href="#" class="button alt">TODO</a>
									</footer>
								</div>
							</div>
						</div>

					</div>
				</div>
			</section>
 


<!-- Two -->
			<section id="two" class="wrapper style2">
				<div class="inner">
					<div class="grid-style">

						<div>
							<div class="box">
								<div class="image fit">
									<img src="images/c00002_d001_1.svg" alt="" />
								</div>
								<div class="content">
									<header class="align-center">
										<p>Het project </p>
										<h2>Temperatuur</h2>
									</header>
									<p>Educatie & Informatievoorziening</p>
									<footer class="align-center">
										<a href="#" class="button alt">TODO</a>
									</footer>
								</div>
							</div>
						</div>

						<div>
							<div class="box">
								<div class="image fit">
									<img src="images/c00002_d001_2.svg" alt="" />
								</div>
								<div class="content">
									<header class="align-center">
										<p>Meer text</p>
										<h2>Meer data</h2>
									</header>
									<p>Bijen houden ook van mooi weer en een schoon huis</p>
									<footer class="align-center">
										<a href="#" class="button alt">TODO</a>
									</footer>
								</div>
							</div>
						</div>

					</div>
				</div>
			</section>

		<!-- Four -->
			<section id="four" class="wrapper style3">
				<div class="inner">
					<header class="align-center">
						<p>Extra informatie</p>
						<h2>Bekijk alle gegevens (afgezet tegen andere bijenkasten)</h2>
					</header>
				</div>
			</section>

		<!-- Five -->
			<section id="five" class="wrapper style2">
				<div class="inner">
					<header class="align-center">
						<p class="special">(relatieve) luchtvochtigheid, licht, (relatieve) luchtdruk, Temperatuur verschil binnen en buiten de kast en CO2 in de kast.</p>
						<h2>Alle grafieken</h2>
					</header>
					<div class="gallery">
						<div>
							<div class="image fit">
								<a href="#"><img src="images/c00002_d001_3.svg" alt="" /></a>
							</div>
						</div>
						<div>
							<div class="image fit">
								<a href="#"><img src="images/c00002_d001_4.svg" alt="" /></a>
							</div>
						</div>
						<div>
							<div class="image fit">
								<a href="#"><img src="images/c00002_d001_5.svg" alt="" /></a>
							</div>
						</div>
						<div>
							<div class="image fit">
								<a href="#"><img src="images/c00002_d001_6.svg" alt="" /></a>
							</div>
						</div>
					</div>
				</div>
			</section>

 
		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
			<script>
				const broker = "wss://uf07096f.ala.eu-central-1.emqxsl.com:8084/mqtt";
				const clientId = "mqtt_test_client_" + Math.random().toString(16).substr(2, 8);
				const options = {
					clientId: clientId,
					clean: true,
					connectTimeout: 4000,
					username: "qr_code_user", // Add your EMQX username
					password: "qr_code_password", // Add your EMQX password
					cleanSession: true,
				};

				let connectionTime;
				let messageTime;
				let waitingTime;
				let startTime;
				let waitingInterval;

				let conversationHistory = [];

				const client = mqtt.connect(broker, options);

				client.on("connect", () => {
					connectionTime = new Date().getTime();
					console.log(`Connection Time is: ${connectionTime}`);

					document.getElementById("status").textContent = "Verbonden met het bijenvolk!";
					console.log("Verbonden met de tussenman.");
					client.subscribe("v000/c00002/d001/answer", (err) => {
						if (err) console.error("Subscribe error:", err);
					});
				});

				client.on("message", (topic, message) => {
					messageTime = new Date().getTime();
					console.log(`Tijd van bericht is: ${messageTime}`);

					// only display message when it is not from a previous interaction
					if ((messageTime - connectionTime) < 2000) {
						console.log("Bericht is van een eerder gesprek. Negeer het!");
						return;
					}

					// display the message 
					console.log(`Ontvangen bericht op topic ${topic}: ${message.toString()}`);
					displayMessage(`${message.toString()}`);
				});

				function publishMessage() {
					const userInput = document.getElementById("message").value;
					if (userInput.length > 200) {
						alert("Uw vraag is te lang. Maximaal 200 tekens toegestaan.");
						return;
					}
					// Add previous Q&A to history (max 6 turns)
					const historyToSend = conversationHistory.slice(-6); // last 3 Q&A pairs
					const jsonPayload = {
					    category: "question",
					    cat_value: userInput,
					    history: historyToSend
					};
					const jsonString = JSON.stringify(jsonPayload);
					console.log("Sending:", jsonString);
					client.publish("v000/c00002/d001/user", jsonString, (err) => {
						if (err) console.error("Publish error:", err);
					});

					startTime = new Date().getTime();
					waitingInterval = setInterval(updateWaitingTime, 1000);

					document.getElementById('llmStatus').innerHTML = 'Vraag verstuurd! Verwerken van het antwoord...';
					document.getElementById("theButton").setAttribute('disabled', 'disabled');
				}

				function displayMessage(msg) {
					clearInterval(waitingInterval);
					document.getElementById("theButton").removeAttribute('disabled');

					document.getElementById('llmStatus').innerHTML = 'Antwoord ontvangen! U kunt nu een vervolg vraag stellen.';
					document.getElementById('waitingTime').innerHTML = `Antwoord gegeven in ${waitingTime} seconden`;

					const msgList = document.getElementById("messages");
					const lastUserInput = document.getElementById("message").value;
					const now = new Date();
					const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

					// Create a Q&A card
					const card = document.createElement("div");
					card.className = "qa-card";
					card.innerHTML = `
					  <div class="qa-header">${timeString}</div>
					  <div class="qa-pair">
					    <div class="qa-user"><strong>Jij:</strong> ${escapeHtml(lastUserInput)}</div>
					    <div class="qa-assistant"><strong>Assistent:</strong> ${escapeHtml(msg)}</div>
					  </div>
					`;

					// Prepend the new Q&A card to the top of the list
					if (msgList.firstChild) {
						msgList.insertBefore(card, msgList.firstChild);
					} else {
						msgList.appendChild(card);
					}

					// Add last Q&A to conversationHistory for memory (as role/content)
					if (lastUserInput && msg) {
						conversationHistory.push({ role: "user", content: lastUserInput });
						conversationHistory.push({ role: "assistant", content: msg });
					}
				}

				// Helper to escape HTML for safe display
				function escapeHtml(text) {
					if (!text) return '';
					return text.replace(/[&<>"']/g, function (c) {
						return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c] || c;
					});
				}

				function updateWaitingTime() {
					const currentTime = new Date().getTime();
					waitingTime = Math.floor((currentTime - startTime) / 1000);
					document.getElementById('waitingTime').innerHTML = `Verwerkingstijd: ${waitingTime} seconden`;

					if (waitingTime > 60) {
						clearInterval(waitingInterval);
						document.getElementById('llmStatus').innerHTML = 'Het duurde te lang. Mogelijk wegens een technisch probleem.';
						document.getElementById('waitingTime').innerHTML = 'Duur van 60 seconden overschreden.';
						document.getElementById("theButton").removeAttribute('disabled');
					}
				}
			</script>


 
	</body>
</html>