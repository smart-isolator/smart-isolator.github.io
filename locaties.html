<!DOCTYPE HTML>
<html>
<head>
    <title>Bijenkasten Locaties - Nederland</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="site-title">üêù Smart-Isolator</div>
            <nav class="main-nav">
                <a href="locaties.html" class="nav-link">üìç Alle Locaties</a>
                <a href="bijen.html" class="nav-link">üêù Bijen Info</a>
                <a href="vegetatie.html" class="nav-link">üåø Vegetatie</a>
                <a href="information.html" class="nav-link">‚ÑπÔ∏è Informatie</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <section id="locations" class="main-wrapper">
        <div class="content-inner">
            <header class="page-header">
                <h2>Alle Bijenkasten in Nederland</h2>
                <p>Ontdek imkers en hun bijenkasten</p>
            </header>
            
            <!-- Small Interactive Map -->
            <div id="map" style="height: 300px; width: 100%; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
            
            <!-- Privacy Disclaimer -->
            <p style="text-align: center; font-size: 0.85rem; color: #666; margin-bottom: 2rem; font-style: italic;">
                üìç Locaties zijn benaderd voor privacy. Geen exacte adressen getoond.
            </p>
            
            <div id="locations-grid" class="locations-grid">
                <p>Locaties laden...</p>
            </div>
        </div>
    </section>

    <!-- Styling -->
    <style>
    /* Reset and base styles */
    * {
        box-sizing: border-box;
    }
    
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: #f8f9fa;
    }
    
    /* Responsive Navigation Header */
    .main-header {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        padding: 1rem 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    
    .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .site-title {
        font-size: 1.3rem;
        font-weight: bold;
    }
    
    .main-nav {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .nav-link {
        color: white;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        background: rgba(255,255,255,0.2);
        transition: all 0.2s;
        white-space: nowrap;
        font-size: 0.9rem;
    }
    
    .nav-link:hover {
        background: rgba(255,255,255,0.3);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }
    
    /* Main layout */
    .main-wrapper {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .content-inner {
        width: 100%;
    }
    
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .page-header h2 {
        margin: 0 0 0.5rem 0;
        color: #333;
        font-size: 2rem;
    }
    
    .page-header p {
        color: #666;
        font-size: 1.1rem;
        margin: 0;
    }
    
    /* Missing button styles */
    .select-button, .popup-button {
        background: #2196F3;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
    }
    
    .select-button:hover, .popup-button:hover {
        background: #1976D2;
    }
    
    .map-popup h4 {
        margin: 0 0 0.5rem 0;
        color: #333;
    }
    
    .map-popup p {
        margin: 0.25rem 0;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
            text-align: center;
        }
        
        .main-nav {
            width: 100%;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .nav-link {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        .main-wrapper {
            padding: 1rem;
        }
        
        .page-header h2 {
            font-size: 1.5rem;
        }
    }
    
    @media (max-width: 480px) {
        .main-nav {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            width: 100%;
        }
        
        .nav-link {
            text-align: center;
            font-size: 0.75rem;
        }
        
        .main-header {
            padding: 1rem;
        }
    }
    
    .locations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }
    
    .location-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }
    
    .location-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .location-card h3 {
        margin: 0 0 0.5rem 0;
        color: #333;
        font-size: 1.2rem;
    }
    
    .location-place {
        color: #666;
        margin-bottom: 1rem;
        font-weight: 500;
    }
    
    .location-description {
        color: #777;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
        max-height: 4rem;
        overflow: hidden;
        line-height: 1.4;
    }
    
    .visit-button {
        background: #4CAF50;
        color: white;
        padding: 0.6rem 1.2rem;
        text-decoration: none;
        border-radius: 4px;
        display: inline-block;
        font-weight: 500;
        transition: background 0.2s ease;
    }
    
    .visit-button:hover {
        background: #45a049;
        color: white;
        text-decoration: none;
    }
    
    .loading-message, .error-message {
        text-align: center;
        padding: 2rem;
        color: #666;
    }
    
    .error-message {
        color: #d32f2f;
    }
    
    .location-card-current {
        border: 2px solid #4CAF50;
        background: #f8fff8;
    }
    
    .current-badge {
        background: #4CAF50;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-bottom: 1rem;
        display: inline-block;
    }
    
    </style>

    <!-- Leaflet Map JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- JavaScript -->
    <script>
    let map;
    let markers = [];
    let currentSelectedHive = null;
    let allValidCards = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        // Server injects hive list
        const hiveIds = ["c00005_d001", "c00002_d001", "c00001_d001", "c99999_d002"];
        
        // Check if coming from a specific hive
        const urlParams = new URLSearchParams(window.location.search);
        const currentHive = urlParams.get('from');
        currentSelectedHive = currentHive;
        
        // Initialize map
        initializeMap();
        
        loadAllLocations(hiveIds, currentHive);
    });
    
    function initializeMap() {
        // Initialize map centered on Netherlands
        map = L.map('map').setView([52.1326, 5.2913], 7);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
    }    function loadAllLocations(hiveIds, currentHive = null) {
        const grid = document.getElementById('locations-grid');
        grid.innerHTML = '<p class="loading-message">Locaties laden...</p>';
        
        if (!hiveIds || hiveIds.length === 0) {
            grid.innerHTML = '<p class="error-message">Geen bijenkasten gevonden.</p>';
            return;
        }
        
        console.log('Loading locations for hives:', hiveIds);
        if (currentHive) {
            console.log('Current hive highlighted:', currentHive);
        }
        
        const promises = hiveIds.map(hiveId => {
            const jsonUrl = `https://smart-isolator.github.io/hive_info/${hiveId}.json?t=${Date.now()}`;
            
            return fetch(jsonUrl)
                .then(response => {
                    if (!response.ok) {
                        console.warn(`Failed to load data for ${hiveId}: ${response.status}`);
                        return null;
                    }
                    return response.json();
                })
                .then(data => data ? createLocationCard(hiveId, data, hiveId === currentHive) : null)
                .catch(error => {
                    console.warn(`Error loading data for ${hiveId}:`, error);
                    return null;
                });
        });
        
        Promise.all(promises).then(cards => {
            const validCards = cards.filter(card => card !== null);
            
            console.log('Total promises:', promises.length);
            console.log('Valid cards found:', validCards.length);
            console.log('Valid cards:', validCards.map(c => c.hiveId));
            
            if (validCards.length > 0) {
                // Store valid cards globally for map updates
                allValidCards = validCards;
                
                // Reorder cards: current hive first (if specified)
                const orderedCards = reorderCards(validCards, currentSelectedHive);
                console.log('Ordered cards count:', orderedCards.length);
                grid.innerHTML = orderedCards.join('');
                
                // Add markers to map (only for hives with postal codes)
                addMarkersToMap(validCards);
            } else {
                grid.innerHTML = '<p class="error-message">Geen locatie-informatie beschikbaar.</p>';
            }
        });
    }

    function createLocationCard(hiveId, data, isCurrent = false) {
        const name = data.naam_imker || 'Onbekende Imker';
        const place = data.plaats || 'Onbekende Locatie';
        const description = data.introductie_imkerij || 'Geen beschrijving beschikbaar';
        
        // Truncate description to prevent overly long cards
        const shortDescription = description.length > 150 ? 
            description.substring(0, 150) + '...' : description;
        
        const currentClass = isCurrent ? ' location-card-current' : '';
        const currentBadge = isCurrent ? '<div class="current-badge">üîç Huidige Bezichtiging</div>' : '';
        
        return {
            html: `
                <div class="location-card${currentClass}" data-hive="${hiveId}" onclick="selectHive('${hiveId}')">
                    ${currentBadge}
                    <h3>${escapeHtml(name)}</h3>
                    <p class="location-place">üìç ${escapeHtml(place)}</p>
                    <p class="location-description">${escapeHtml(shortDescription)}</p>
                    <a href="index_${hiveId}.html" class="visit-button" onclick="event.stopPropagation()">Bezoek Bijenkast</a>
                    ${isCurrent ? '' : '<button class="select-button" onclick="event.stopPropagation(); selectHive(\'' + hiveId + '\');">Selecteer</button>'}
                </div>
            `,
            isCurrent: isCurrent,
            hiveId: hiveId,
            data: data
        };
    }

    function selectHive(hiveId) {
        currentSelectedHive = hiveId;
        
        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('from', hiveId);
        window.history.replaceState({}, '', url);
        
        // Recreate cards with new selection state
        const updatedCards = allValidCards.map(card => {
            const isCurrent = (card.hiveId === hiveId);
            return createLocationCard(card.hiveId, card.data, isCurrent);
        });
        
        // Update global cards array
        allValidCards = updatedCards;
        
        // Reorder cards
        const orderedCards = reorderCards(updatedCards, hiveId);
        const grid = document.getElementById('locations-grid');
        grid.innerHTML = orderedCards.join('');
        
        // Update map markers
        updateMapSelection(hiveId);
    }
    
    async function addMarkersToMap(validCards) {
        // Clear existing markers and circles
        markers.forEach(marker => {
            map.removeLayer(marker);
            if (marker.uncertaintyCircle) {
                map.removeLayer(marker.uncertaintyCircle);
            }
        });
        markers = [];
        
        const markersToAdd = [];
        
        for (const card of validCards) {
            const data = card.data;
            const postcode = data.postcode;
            
            // Only add markers for hives with postal codes
            if (postcode && postcode.length >= 4) {
                try {
                    // Use full postal code for better geocoding
                    const coords = await geocodePostalCode(postcode);
                    
                    if (coords) {
                        const marker = createInteractiveMarker(coords, card);
                        markersToAdd.push(marker);
                    }
                } catch (error) {
                    console.warn(`Failed to geocode postal code ${postcode}:`, error);
                }
            }
        }
        
        // Add all markers and circles, then fit map bounds
        if (markersToAdd.length > 0) {
            markersToAdd.forEach(marker => {
                markers.push(marker);
                marker.addTo(map);
                // Add uncertainty circle
                if (marker.uncertaintyCircle) {
                    marker.uncertaintyCircle.addTo(map);
                }
            });
            
            // Fit map to show all markers
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }
    
    async function geocodePostalCode(fullPostalCode) {
        try {
            // First try with full postal code (works best with 6 digits like 2592RN)
            if (fullPostalCode && fullPostalCode.length >= 6) {
                // Try Nominatim first
                const nominatimCoords = await geocodeWithNominatim(fullPostalCode);
                if (nominatimCoords) {
                    return nominatimCoords;
                }
                
                // Fallback to PDOK API
                const pdokCoords = await geocodeWithPDOK(fullPostalCode);
                if (pdokCoords) {
                    return pdokCoords;
                }
            }
            
            // For 4-digit postal codes, get a random 6-digit code from PDOK
            const postalCode4 = fullPostalCode.toString().substring(0, 4);
            const randomSixDigitCode = await getRandomSixDigitPostalCode(postalCode4);
            
            if (randomSixDigitCode) {
                // Try geocoding the random 6-digit postal code
                const nominatimCoords = await geocodeWithNominatim(randomSixDigitCode);
                if (nominatimCoords) {
                    console.log(`Geocoded ${fullPostalCode} via random 6-digit ${randomSixDigitCode}`);
                    return nominatimCoords;
                }
                
                // Fallback to PDOK for the random code
                const pdokCoords = await geocodeWithPDOK(randomSixDigitCode);
                if (pdokCoords) {
                    console.log(`Geocoded ${fullPostalCode} via random 6-digit ${randomSixDigitCode} using PDOK`);
                    return pdokCoords;
                }
            }
        } catch (error) {
            console.warn('Postal code geocoding error:', error);
        }
        return null;
    }
    
    async function geocodeWithNominatim(postalCode) {
        try {
            const query = encodeURIComponent(`${postalCode} Netherlands`);
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=nl&limit=1&addressdetails=1`);
            const results = await response.json();
            
            if (results && results.length > 0) {
                let lat = parseFloat(results[0].lat);
                let lon = parseFloat(results[0].lon);
                
                // Add small random offset
                const offsetLat = (Math.random() - 0.5) * 0.002; // ~100m
                const offsetLon = (Math.random() - 0.5) * 0.003; // ~100m
                
                lat += offsetLat;
                lon += offsetLon;
                
                console.log(`Geocoded ${postalCode} with Nominatim to:`, lat, lon, '(with small random offset)');
                return [lat, lon];
            }
        } catch (error) {
            console.warn(`Nominatim geocoding failed for ${postalCode}:`, error);
        }
        return null;
    }
    
    async function geocodeWithPDOK(postalCode) {
        try {
            // Search for the postal code using PDOK
            const searchUrl = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=${postalCode}&fq=type:postcode`;
            const searchResponse = await fetch(searchUrl);
            const searchData = await searchResponse.json();
            
            if (searchData.response && searchData.response.docs && searchData.response.docs.length > 0) {
                // Get the first matching postal code ID
                const doc = searchData.response.docs[0];
                
                // Look up detailed info including coordinates
                const lookupUrl = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=${doc.id}`;
                const lookupResponse = await fetch(lookupUrl);
                const lookupData = await lookupResponse.json();
                
                if (lookupData.response && lookupData.response.docs && lookupData.response.docs.length > 0) {
                    const detailDoc = lookupData.response.docs[0];
                    
                    // Parse coordinates from "POINT(lon lat)" format
                    const coordsMatch = detailDoc.centroide_ll.match(/POINT\(([\d.-]+)\s+([\d.-]+)\)/);
                    if (coordsMatch) {
                        let lon = parseFloat(coordsMatch[1]);
                        let lat = parseFloat(coordsMatch[2]);
                        
                        // Add small random offset
                        const offsetLat = (Math.random() - 0.5) * 0.002; // ~100m
                        const offsetLon = (Math.random() - 0.5) * 0.003; // ~100m
                        
                        lat += offsetLat;
                        lon += offsetLon;
                        
                        console.log(`Geocoded ${postalCode} with PDOK to:`, lat, lon, '(with small random offset)');
                        return [lat, lon];
                    }
                }
            }
        } catch (error) {
            console.warn(`PDOK geocoding failed for ${postalCode}:`, error);
        }
        return null;
    }
    
    async function getRandomSixDigitPostalCode(fourDigitCode) {
        try {
            // Use PDOK Locatieserver API - CORS-friendly Dutch government API
            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=${fourDigitCode}&fq=type:postcode`;
            const response = await fetch(url);
            
            if (!response.ok) {
                console.warn(`Failed to fetch postal codes for ${fourDigitCode}`);
                return null;
            }
            
            const data = await response.json();
            
            if (data.response && data.response.docs && data.response.docs.length > 0) {
                // Extract postal codes from the weergavenaam field
                const postalCodes = data.response.docs
                    .map(doc => {
                        // Extract postal code from "Streetname, 2592HP 's-Gravenhage" format
                        const match = doc.weergavenaam.match(/(\d{4}[A-Z]{2})/);
                        return match ? match[1] : null;
                    })
                    .filter(code => code && code.startsWith(fourDigitCode));
                
                if (postalCodes.length > 0) {
                    // Remove duplicates and randomly pick one
                    const uniqueCodes = [...new Set(postalCodes)];
                    const randomIndex = Math.floor(Math.random() * uniqueCodes.length);
                    const selectedCode = uniqueCodes[randomIndex];
                    
                    console.log(`Found ${uniqueCodes.length} postal codes for ${fourDigitCode}, selected: ${selectedCode}`);
                    return selectedCode;
                }
            }
            
            console.warn(`No postal codes found for ${fourDigitCode}`);
            return null;
        } catch (error) {
            console.warn(`Error fetching postal codes for ${fourDigitCode}:`, error);
            return null;
        }
    }
    
    function createInteractiveMarker(coords, card) {
        const data = card.data;
        const name = data.naam_imker || 'Onbekende Imker';
        const hiveId = card.hiveId;
        const postcode = data.postcode;
        
        // Determine if this is the currently selected hive
        const isSelected = (hiveId === currentSelectedHive);
        
        // Create marker with different appearance for selected hive
        const markerColor = isSelected ? '#4CAF50' : '#ff6b35';
        const markerSize = isSelected ? 20 : 16;
        
        const marker = L.marker(coords, {
            icon: L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: ${markerColor}; width: ${markerSize}px; height: ${markerSize}px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                iconSize: [markerSize, markerSize],
                iconAnchor: [markerSize/2, markerSize/2]
            })
        });
        
        // Add uncertainty circle based on postal code precision
        const radius = postcode && postcode.length >= 6 ? 500 : 1000; // 500m for 6-digit, 1000m for 4-digit
        const circle = L.circle(coords, {
            color: '#2196F3',
            fillColor: '#2196F3',
            fillOpacity: 0.1,
            opacity: 0.3,
            weight: 1,
            radius: radius
        });
        
        // Store circle reference in marker for cleanup
        marker.uncertaintyCircle = circle;
        
        // Add click handler to select this hive
        marker.on('click', function() {
            selectHive(hiveId);
        });
        
        // Store hive ID in marker for updates
        marker.hiveId = hiveId;
        
        // Add popup with hive info and precision indicator
        const precisionText = postcode && postcode.length >= 6 ? 'Nauwkeurigheid: ~500m' : 'Nauwkeurigheid: ~1km';
        const popupContent = `
            <div class="map-popup">
                <h4>üêù ${escapeHtml(name)}</h4>
                <p>üìç ${escapeHtml(postcode)}</p>
                <p style="font-size: 0.8rem; color: #666;">${precisionText}</p>
                <button onclick="selectHive('${hiveId}')" class="popup-button">Selecteer Bijenkast</button>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        return marker;
    }
    
    function updateMapSelection(selectedHiveId) {
        // Update all markers and their circles to reflect new selection
        markers.forEach(marker => {
            const isSelected = (marker.hiveId === selectedHiveId);
            const markerColor = isSelected ? '#4CAF50' : '#ff6b35';
            const markerSize = isSelected ? 20 : 16;
            
            // Update marker icon
            marker.setIcon(L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: ${markerColor}; width: ${markerSize}px; height: ${markerSize}px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                iconSize: [markerSize, markerSize],
                iconAnchor: [markerSize/2, markerSize/2]
            }));
            
            // Update circle visibility - show more prominently for selected hive
            if (marker.uncertaintyCircle) {
                const circleOpacity = isSelected ? 0.5 : 0.3;
                const fillOpacity = isSelected ? 0.2 : 0.1;
                marker.uncertaintyCircle.setStyle({
                    opacity: circleOpacity,
                    fillOpacity: fillOpacity
                });
            }
        });
    }

    function reorderCards(cards, currentHive) {
        if (!currentHive) {
            return cards.map(card => card.html);
        }
        
        // Separate current hive from others
        const currentCard = cards.find(card => card.isCurrent);
        const otherCards = cards.filter(card => !card.isCurrent);
        
        // Return current card first, then others
        const orderedCards = [];
        if (currentCard) {
            orderedCards.push(currentCard.html);
        }
        otherCards.forEach(card => orderedCards.push(card.html));
        
        return orderedCards;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    </script>

    <!-- Footer -->
    <footer class="site-disclaimer" style="text-align:center; color:#888; font-size:0.95em; margin:2em 0 1em 0;">
        <p>Smart-Isolator - Bijenkasten Locaties</p>
        <p>Ontdek imkers en hun bijenkasten door heel Nederland</p>
    </footer>

    <!-- Lightweight - no external JS dependencies needed -->
</body>
</html>